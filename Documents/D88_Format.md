.D88形式自体の構造に関する情報 と、その中に格納されるHu-BASICファイルシステムの構造に関する情報 が含まれています。C#での実装では、これら両方の側面を理解する必要があります。

以下に、ご要望の機能実装に必要な情報を記載します。

### 1. D88形式ファイルフォーマット全般について必要な情報

.D88形式は、ヘッダ、トラック先頭オフセット配列、およびセクタブロックの順に連結されて構成されるフロッピーディスクイメージフォーマットです。特に明記されていない複数バイトの数値データは、**リトルエンディアン**で格納されます。

*   **全体構造**:
    *   **ヘッダ (Header)**: ファイルの先頭に位置し、サイズは **0x2b0 バイト (688バイト)** です。ディスクに関する構造情報を含みます。
    *   **トラック先頭オフセット配列 (Track Offsets)**: ヘッダの直後、オフセット 0x20 から配置されます。サイズは **4 * 164 = 656バイト (0x290)** です。ファイル先頭からの各トラックの開始位置オフセットを記録しており、トラック 0 から 163 までの順で、1トラックあたり4バイトのDword値 (リトルエンディアン) です。使用されていないトラックのエントリは 0 に設定されます。
    *   **セクタブロック (Sector Blocks)**: 各トラックに含まれるセクタが連続して配置されたものです。各セクタはセクタヘッダとそのデータブロックから構成されます。ディスクイメージ内のセクタの物理的な順序（シリンダー/ヘッド/セクタ番号順）であることは保証されません。

*   **ヘッダの詳細**:
    *   **ディスク名 (Image name)**: サイズ **17バイト**。C文字列 (末尾が 0x00) で、最大16文字です。
    *   **予約 (Reserved)**: サイズ **9バイト**。通常はすべて 0x00 です。
    *   **ライトプロテクト (Protect)**: サイズ **1バイト**。**0x00**=なし、**0x10**=あり (非ゼロ値で有効)。
    *   **ディスクの種類 (Media type)**: サイズ **1バイト**。ディスクの物理フォーマットを示します。
        *   **0x00**: 2D
        *   **0x10**: 2DD
        *   **0x20**: 2HD
        *   0x30: 1D
        *   0x40: 1DD
    *   **ディスクサイズ (Disk size)**: サイズ **4バイト (Dword)**。ヘッダと全トラックの合計サイズです (リトルエンディアン)。
    *   **トラック先頭のオフセット (Track offsets)**: サイズ **4*164バイト**。ファイル先頭からの各トラックのオフセット配列です。詳細前述。

*   **トラックの詳細**:
    *   トラックは複数のセクタが順に連結されたものです。
    *   トラックに含まれるセクタ数とサイズはディスクの種類によって異なります。
    *   最大トラック数は 164 です。

*   **セクタの詳細**:
    *   各セクタブロックは **16バイトのセクタヘッダ**とその後に続く **データ** から構成されます。
    *   **セクタヘッダ (Sector Header)**:
        *   **トラック(C)**: サイズ **1バイト**。シリンダー番号 (0から)。
        *   **サイド(H)**: サイズ **1バイト**。ヘッド/サイド番号 (0=表面, 1=裏面)。
        *   **セクタ(R)**: サイズ **1バイト**。セクタ/レコード番号 (1から)。
        *   **セクタサイズ(N)**: サイズ **1バイト**。セクタのデータサイズ。値 N からサイズ S への変換は **S = 128 << N (128 * 2^N)** です。
            *   0: 128 bytes
            *   1: 256 bytes
            *   2: 512 bytes
            *   3: 1024 bytes
        *   **トラック中のセクタ数 (Number of sectors)**: サイズ **2バイト (Word)**。そのトラックに含まれるセクタの総数 (リトルエンディアン)。
        *   **記録密度 (Density)**: サイズ **1バイト**。
            *   **0x00**: 倍密度 (Double density - DD)
            *   0x40: 単密度 (Single density - D)
            *   0x01: 高密度 (High density - HD)
        *   **削除フラグ (DDAM)**: サイズ **1バイト**。0x00=通常、0x10=削除。
        *   **ステータス (FDC status)**: サイズ **1バイト**。フロッピーディスクコントローラ (FDC) の状態。0x00=正常。その他、エラー値などがあります。
            *   **実装時の注意**: 0x00以外のステータスを持つセクタは破損セクタとして扱われます。Legacy89DiskKitでは、破損セクタの読み込み時に警告を表示し、部分復旧機能でこれらのセクタを検出・処理します。
        *   **予約 (Reserved)**: サイズ **5バイト**。通常はすべて 0x00 です。
        *   **このセクタのデータサイズ (Actual size)**: サイズ **2バイト (Word)**。セクタヘッダに続く実際のデータサイズ (リトルエンディアン)。通常はセクタサイズと同じですが、0バイトの場合もあります。
    *   **データ (Data)**: サイズは「このセクタのデータサイズ」フィールドで示されるバイト数です。

### 2. 新規D88イメージ生成に必要な情報 (2D / 2DD / 2HD それぞれの要件を満たすこと)

新規の.D88イメージを作成するには、まずディスクの物理的な構造（トラック数、面数、1トラックあたりのセクタ数、セクタサイズ）を決定し、それに従ってヘッダ、トラックオフセット配列、すべてのセクタブロックを構築する必要があります。Hu-BASICフォーマットの空ディスクを作成する場合は、ファイルシステム領域（ブートセクタ、FAT、ディレクトリ）も初期化する必要があります。

*   **ディスク構造の定義**: 一般的なSharp X1 / Hu-BASIC環境での設定を基準とします。ソースに基づくと、セクタサイズは N=1 (256バイト) が標準的です。
    *   **2D**: トラック数 40/面 * 2面 = **80トラック**。1トラックあたり **16セクタ**。セクタサイズ **256バイト**。密度 **0x00 (倍密度)**。
    *   **2DD**: トラック数 80/面 * 2面 = **160トラック** (推定、ソースには明確な総トラック数記載なし、最大164はサポート)。1トラックあたり **16セクタ** (推定)。セクタサイズ **256バイト** (推定)。密度 **0x00 (倍密度)**。FATクラスタ数は160。
    *   **2HD**: トラック数 77/面 * 2面 = **154トラック** (推定、ソースが0-76トラックを例示)。1トラックあたり **26セクタ**。セクタサイズ **256バイト** (推定、ソース、の例)。密度 **0x01 (高密度)**。FATクラスタ数は250。

*   **ヘッダの生成**:
    *   ディスク名: 任意の文字列 (最大16文字+0x00)。空ディスクなら任意。
    *   予約: 9バイトを 0x00 で埋める。
    *   ライトプロテクト: 0x00 (なし) を設定。
    *   ディスクの種類: 上記で定義した 0x00, 0x10, または 0x20 を設定。
    *   トラック先頭のオフセット配列: 4*164バイトの配列を作成。使用するトラック数に応じてオフセット値を計算して格納し、残りは 0 を設定。計算方法は後述。
    *   ディスクサイズ: ファイル全体のサイズを計算して格納 (リトルエンディアン)。計算方法は後述。

*   **セクタブロックの生成**:
    *   定義したトラック数、面数、セクタ数/トラック、セクタサイズに従って、すべてのセクタブロックを順に生成。
    *   各セクタブロックはセクタヘッダ (16バイト) + データ部から構成。
    *   **セクタヘッダ**には、対応する C, H, R 番号、トラック中のセクタ数、密度、通常ステータス (0x00)、削除フラグ (0x00)、実際のデータサイズ（セクタサイズに等しくする）、予約 (0x00) などを設定。
    *   **セクタデータ**は、空ディスクの場合、例えば 0xE5 などで埋めることが一般的ですが、ソースには特定のデフォルト値の記載はありません。

*   **Hu-BASICファイルシステム領域の初期化 (空ディスクの場合)**:
    *   ブートセクタ (トラック0, 0面, 1セクタ目): 32バイトのエントリを初期化。ブートフラグは 0x00 (非起動可能) または 0x01 (IPL用起動可能)。拡張子は 'Sys'+0x20。その他フィールドも必要に応じて設定またはゼロクリア。
    *   アロケーションテーブル (FAT):
        *   2D: トラック0の15セクタ目。1セクタ長。
        *   2HD: トラック1の3セクタ目 (物理29セクタ目)。2セクタ長。
        *   FATエントリを初期化。最初の予約クラスタ分 (2D: 2クラスタ、2HD: 3クラスタ) は特定の値 (2D: 0x01, 0x8F、2HD: 0x01, 0x8F, 0x8F) に、それ以外は 0x00 (未使用) に設定。
    *   ルートディレクトリ:
        *   2D: トラック1の1セクタ目 (物理17セクタ目)。16セクタ長。
        *   2HD: トラック1の7セクタ目 (物理33セクタ目)。長さはソースに明確な記載なし、ただしエントリ数は247まで可能。
        *   ディレクトリエントリは32バイト/エントリ。すべてのエントリを 0xFF (エントリ終了) または 0x00 (削除済み) で初期化。

*   **オフセット計算とヘッダ更新**:
    *   すべてのセクタブロックのサイズ合計 (セクタヘッダ16バイト + データサイズ) を計算。
    *   各トラックのファイル先頭からのオフセットを計算。最初のトラック (トラック0) はヘッダサイズの 0x2b0 から開始。以降のトラックは、前のトラックの開始オフセットに、前のトラックに含まれる全セクタの合計サイズを加算して求めます。計算したオフセット値をトラック先頭オフセット配列に格納。
    *   ディスクサイズは ヘッダサイズ (0x2b0) + 全セクタブロックのサイズ合計 となります。計算した値をヘッダのディスクサイズフィールドに格納 (リトルエンディアン)。

### 3. 既存のD88イメージ読み込みに必要な情報 (2D / 2DD / 2HD それぞれの要件を満たすこと)

既存の.D88イメージを読み込むには、まずファイル全体の構造を解析し、次に必要に応じてその中のHu-BASICファイルシステム構造を解析します。

*   **D88構造の解析**:
    *   ファイルを開き、先頭から 0x2b0 バイトを読み込んでヘッダ情報を取得。
    *   ヘッダを解析。特に以下を抽出:
        *   ディスクの種類 (Media type): これにより、Hu-BASICファイルシステム構造を解釈する際のトラック数、セクタ数、FAT/ディレクトリ位置などの目安が得られます。
        *   ディスクサイズ (Disk size): ファイルの総サイズを示します。
        *   トラック先頭オフセット配列 (Track offsets): 0x20 から始まる 656バイトの配列を読み込みます。各トラックのデータがファイル内のどこから始まるかを示します。
    *   トラック先頭オフセット配列を基に、各トラックのセクタデータを読み込みます。オフセットが 0 のエントリは、そのトラックがイメージに含まれていないことを示します。
    *   各トラックの開始オフセットから、セクタヘッダ (16バイト) を順に読み込みます。
    *   セクタヘッダを解析。特に以下を抽出:
        *   トラック(C)、サイド(H)、セクタ(R) 番号: セクタの論理的な位置を示します。
        *   セクタサイズ(N): データサイズ計算のための指数。
        *   記録密度 (Density): セクタの記録密度。
        *   ステータス (FDC status): セクタの読み取り状態 (正常かエラーかなど)。0x00が正常。
        *   **このセクタのデータサイズ (Actual size)**: セクタヘッダの直後に続く実際のデータバイト数。**この値を使用して、実際に読み込むデータ量を決定します**。
    *   セクタヘッダの解析後、`Actual size` バイトだけファイルから読み込んでセクタデータとします。
    *   次のセクタは、現在のセクタデータの直後に続きます。次のトラックのオフセットに達するか、ディスクサイズの終わりに達するまで、セクタヘッダとデータを繰り返し読み込みます。
    *   読み込んだセクタは、C, H, R 番号を基にメモリ上で論理的に整理すると、ファイルシステム解析が容易になります。

*   **Hu-BASICファイルシステム構造の解析 (Hu-BASICディスクの場合)**:
    *   ディスク種類がHu-BASICフォーマットを示す場合 (例: 2D, 2DD, 2HD)、Hu-BASICファイルシステム構造を解析します。
    *   ブートセクタ (C=0, H=0, R=1) を探し、そのセクタデータ (32バイト) を読み込み、ブートフラグ、ラベル、ロード/実行アドレスなどを解析します。日付フィールドはBCD形式。
    *   アロケーションテーブル (FAT) を読み込み、解析します。位置はディスク種類 (2D/2HD) に依存。FATエントリを解析し、クラスタの利用状況 (未使用, ファイル終端, 次クラスタ) を把握します。2HD固有の格納方法 (上位/下位ビット) に注意が必要です。予約クラスタのエントリ意味も考慮します。
    *   ルートディレクトリを読み込み、解析します。位置はディスク種類 (2D/2HD) に依存。32バイトごとのディレクトリエントリを順に読み込み、ファイルモードが 0xFF になるまで解析を続けます。
    *   各ディレクトリエントリから、ファイルモード/属性、ファイル名、拡張子、サイズ、ロード/実行アドレス、日付、開始クラスタなどを抽出します。ファイル名/拡張子は0x20パディング、日付はBCD形式 です。開始クラスタはHIGH, LOW, MIDDLEから計算。
    *   ファイルデータを読み込むには、ディレクトリエントリの「開始クラスタ」からFATをたどり、ファイルが使用しているすべてのクラスタ番号を取得します。
    *   取得したクラスタ番号を物理的な C, H 番号に変換します。2Dの場合、クラスタ N は C=N/2, H=N%2 に対応します。そのクラスタに含まれるセクタ (2Dなら16個、2HDなら26個) の C, H, R 番号を特定し、それに対応するセクタデータをD88イメージ内の読み込んだセクタリストから探して結合することで、ファイルデータを復元します。

これらの情報がC#での.D88ファイル処理実装の助けとなれば幸いです。特にリトルエンディアンでの読み書き、オフセット計算、セクタヘッダ情報の正確な解釈、Hu-BASICファイルシステムにおける予約領域やFAT連鎖、ディレクトリ構造の解釈、BCD形式の日付変換、開始クラスタからC/H/Rへの変換などが実装の重要なポイントになります。