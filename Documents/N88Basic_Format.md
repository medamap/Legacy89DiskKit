-------------------------------------------------------------------------------
PC-8801 N88-BASIC ディスクフォーマット仕様書 (D88イメージアクセス向け)
本仕様書は、提供された技術解説資料に基づき、PC-8801のN88-BASICフォーマットされたフロッピーディスクイメージ、特にD88ファイル形式にC#プログラムからアクセスし操作するための基本的な構造とロジックについて記述します。
I. フロッピーディスクの物理/低レベル基礎
A. 主要な物理メディアタイプ
PC-8801シリーズで最も普及していたのは5.25インチの両面倍密度（2D）ディスクです。後期モデルでは2DDおよび2HDディスクもサポートされました。
•
2D (Double Density): 5.25インチ、2面、40トラック/面、標準16セクタ/トラック (MFM)、標準256バイト/セクタ (MFM)、300 RPM、250 Kb/s。フォーマット容量は320KB。
•
2DD (Double Density, Double Track): 5.25インチ、2面、80トラック/面、標準16セクタ/トラック (MFM)、標準256バイト/セクタ (MFM)、300 RPM、250 Kb/s。フォーマット容量は640KB。
•
2HD (High Density): 5.25インチ、2面、77トラック/面、標準8セクタ/トラック (MFM)、標準1024バイト/セクタ (MFM)、360 RPM、500 Kb/s。フォーマット容量は約1.2MB。
B. データエンコーディング方式
データ記録にはFM (Frequency Modulation) とMFM (Modified Frequency Modulation) が使用されました。
•
FM (周波数変調): シングルデンシティ方式。主にブートストラップ用のトラック0で使用されました。単純で信頼性が高い特徴があります.。
•
MFM (変形周波数変調): ダブルデンシティ方式。2D, 2DD, 2HDディスクのデータトラックにおける標準的なエンコーディングです。FMの約2倍の記録密度を実現します。
C. FDCとディスクサブシステム
PC-8801は、NEC製µPD765Aまたは互換FDCチップを採用しています。FDCは低レベルの読み書き操作を司ります。PC-8801には、メインCPUとFDCの間にディスクサブシステムが存在し、FDC操作をオフロードし、コマンド処理を行います。これによりディスクI/Oが簡素化され、機能拡張（例: 2HDサポート）が可能となりました.。
D. 低レベルディスク構造 (トラック/セクタ)
ディスク表面は同心円状のトラックに分割され、各トラックはセクタに分割されます。セクタは最小アドレス単位です。データ整合性のため、セクタ間やトラック末尾にはギャップが設けられています。インデックスホールはトラックの開始点を認識するために使用されます。
E. MFMセクタフォーマット詳細
標準的なMFMセクタフォーマットは、IDフィールドとデータフィールドから構成されます。それぞれ同期バイト、アドレスマーク、データ、CRCを持ちます。
MFMセクタ構造の一般的な要素（D88セクタヘッダに関連）:
•
IDアドレスマーク (IDAM): IDフィールドの開始を示す特殊パターン (例: A1h x3 + FEh)。
•
IDフィールド: セクタ識別情報。
◦
C (Cylinder/Track Number): 1バイト。
◦
H (Head/Side Number): 1バイト。
◦
R (Record/Sector ID): 1バイト。
◦
N (Sector Size Code): 1バイト。実際のセクタサイズは 128 \ll N で計算されます。PC-8801のMFMデータセクタではN=1（256バイト）が一般的です。
◦
ID CRC: 2バイト。ID情報の整合性を保証します。
•
データアドレスマーク (DAM/DDAM): ユーザーデータフィールドの開始を示す特殊パターン。FBhが通常データ (DAM)、F8hが削除データ (DDAM) を示します。
•
データフィールド: 実際のユーザーデータ。サイズはN値で決定されます。
•
データCRC: 2バイト。データフィールドの整合性を保証します.。
FDCはIDAMを探索し、IDフィールド(C,H,R,N)を読んで目的のセクタを見つけます。IDフィールドとデータフィールドに個別のCRCがあることで、エラー検出が可能です。
F. FMセクタフォーマット概要
FMはより単純なエンコーディングです。トラック0のブート領域（IPL）で使用されます.。FMセクタもIDフィールドとデータフィールドを持ち、アドレスマーク（例: IDAMにFEh、DAMにFBh）を使用しますが、エンコーディング自体は異なります。PC-8801のトラック0におけるFMセクタのサイズは、多くの場合128バイトです.。
II. N88-BASIC ファイルシステム
N88-BASICは独自のディスクフォーマットを採用しており、MS-DOS等との互換性はありません.。
A. 標準フォーマットディスクレイアウト
N88-BASICはシステム情報（ディレクトリ、IDセクタ、FAT）を特定のシステムトラックに配置します.。
•
2D (40トラック) ディスク: システム情報はトラック18、ヘッド1に配置されます。
•
2DD (80トラック) ディスク: システム情報はトラック40、ヘッド0に配置されます。
B. IDセクタ
システムトラックに存在します。ディスク属性情報を含みます.。
•
バイト0: ディスクメディア属性.。
•
バイト1: 起動時のファイル数（例: FFhでプロンプトスキップ）。BASICの内部バッファに関連する可能性があります.。
•
バイト2-255: 起動時に実行されるBASICコード（オートラン）。
IDセクタは2DではT18/H1/S13、2DDではT40/H0/S13に位置します.。
C. DSKF関数によるパラメータ
N88-BASICのDSKF関数は、ディスクの特性を返すために使用されます.。
•
DSKF(ドライブ, 0): 最大トラック番号.
•
DSKF(ドライブ, 1): トラックあたりのセクタ数.
•
DSKF(ドライブ, 2): 片面(0)か両面(1)か.
•
DSKF(ドライブ, 5): ディレクトリ情報を含むトラックのインデックス（システムトラック）.
•
DSKF(ドライブ, 6): クラスタあたりのセクタ数.
•
DSKF(ドライブ, 7): FATの開始セクタ.
•
DSKF(ドライブ, 8): FATの最終セクタ.
•
DSKF(ドライブ, 10): IDを含むセクタのインデックス (IDセクタ).
D. FAT (ファイルアロケーションテーブル)
FATはシステムトラック上に配置され、クラスタの割り当てとファイルチェーンを管理します.。
•
配置場所: 2DはT18/H1/S14-16、2DDはT40/H0/S14-16.。通常3つのコピーがあります.。
•
構造: クラスタあたり1バイトまたは2バイトのエントリ.。フロッピーではクラスタ数が少ないため1バイトが一般的と思われます（ただしソースは1バイトまたは2バイトと記載）.
•
エントリの意味:
◦
(FF)FFh: 空きクラスタ.
◦
0000h - (最大クラスタ数-1): 次のクラスタ番号へのポインタ.
◦
C0h + 使用セクタ数: ファイルの最終クラスタ.
◦
(FF)FEh: システム使用中クラスタ（ディレクトリ、FAT等）/予約済み.
◦
(FF)FDh: 不良クラスタ（主にHDD向け）.
E. ディレクトリ構造
ディレクトリはシステムトラック上に配置され、ファイル情報を格納します.。
•
配置場所: 2DはT18/H1/S1-12、2DDはT40/H0/S1-12.。
F. ディレクトリエントリ詳細
各エントリは16バイトです.。
•
最初のバイト: FFhは未使用、00hは削除済み.。
•
バイト 0-5: ファイル名 (6文字, ASCII/Shift-JIS).
•
バイト 6-8: 拡張子 (3文字, ASCII/Shift-JIS).
•
バイト 9: ファイル属性 (1バイト, ビットフィールド).
•
バイト 10: 開始クラスタ番号 (1バイト).
•
バイト 11-15: システム予約 (未使用).
最大ファイル数はディレクトリセクタ数に依存しますが、N88-BASICの内部制限で128個までという情報もあります.。
G. ファイル属性バイト詳細 (ディレクトリエントリのバイト9)
属性バイトはビットフィールドで、ファイルの種類や特性を示します.。
•
ビット0: 1 = 機械語フォーマット（バイナリ）.
•
ビット1-3: システム予約.
•
ビット4: 1 = 書き込み禁止.
•
ビット5: 1 = 編集禁止 (Pオプション/プロテクト).
•
ビット6: 1 = 書き込み後読み取り検証.
•
ビット7: 1 = 非ASCIIフォーマット (トークン化BASIC), 0 = ASCIIフォーマット (テキスト).
H. クラスタ定義
クラスタは連続したセクタのグループであり、ファイル割り当ての最小単位です.。
•
40トラックフォーマット (2D): 1クラスタは8セクタ（トラックの半分）.。1クラスタ = 8セクタ * 256バイト/セクタ = 2KB.
•
その他のフォーマット (2DD/2HD): 1クラスタは1トラック全体.。2DDの場合、1クラスタ = 16セクタ * 256バイト/セクタ = 4KB.
•
クラスタあたりのセクタ数はDSKF(ドライブ, 6)で確認できます.。
I. ファイルタイプと格納形式
•
ASCIIファイル: プレーンテキスト。属性ビット7は0.。行末は通常0D0Ah (CRLF).。
•
トークン化BASICプログラム: 属性ビット7は1.。先頭2バイトがリンクポインタ、続く2バイトが行番号.。特殊なバイト列でコマンドやデータを表現します.。
•
バイナリ/機械語ファイル: RAWバイナリデータ。属性ビット0は1.。BLOAD/BSAVEコマンドで扱われます.。
III. ブートプロセス
A. ブートシーケンス概要
電源投入/リセット時、ROMはドライブ1のトラック0、セクタ1からIPLをロードしようとします.。このIPLがOSやアプリケーションをロードします.。ディスクサブシステムの「Load & Go (10h)」コマンドはこの動作をサポートします.。
B. IPL (Initial Program Loader)
•
配置場所: トラック0、ヘッド0、セクタ1.
•
エンコーディング: 通常FMエンコード (128バイトセクタ).。IPL自体は256バイト長である可能性が示唆されています.（物理FMセクタ2つ分を論理的に読むか、システムが256バイトとして扱う）.。
•
機能: メインのN88-DISK BASICシステムファイルやアプリケーションをRAMにロードします.。IDセクタのBASICコードを実行する場合もあります.。
C. 商用ソフトウェアのカスタムブート
多くの商用ゲームは、トラック0、セクタ1に独自のカスタムIPLを持ち、N88-BASICをバイパスして直接起動します.。これらのIPLは非標準のフォーマット（トラック/セクタレイアウト、エンコーディング等）を使用することが多く、コピープロテクションの一部となっています.。分析にはIPLの逆アセンブルが必要です.。
トラック0のFMエンコードは、システムが最小限の構成で確実にIPLを読み込み、その後より複雑なMFMフォーマットを処理するための「立ち上げ」メカニズムです.。
IV. D88ディスクイメージフォーマット
D88フォーマットはPC-8801/9801エミュレータで広く使用され、複数のディスクイメージを格納できます.。複数バイト値はリトルエンディアンです.。
A. D88ファイル構造概要
•
グローバルディスクヘッダ: ファイル内のディスクイメージごとに存在 (672または688バイト).
•
トラックデータエリア: ヘッダのトラックテーブルに示されるオフセットに配置. 各トラックのRAWセクタデータを格納.。
•
セクタデータ表現: トラックデータエリア内で、各セクタは16バイトのセクタヘッダとそれに続くセクタデータとして表現されます.。
B. グローバルディスクヘッダ詳細
D88ヘッダ構造 (ファイルの先頭から):
•
00h-0Fh (16バイト): ディスク名/コメント (ASCII).
•
10h (1バイト): コメント終端文字 (00h).
•
11h-19h (9バイト): 予約済み (00h).
•
1Ah (1バイト): 書き込み禁止フラグ (00h=通常, 10h=禁止).
•
1Bh (1バイト): メディアフラグ (00h=2D, 10h=2DD, 20h=2HD等). ディスクジオメトリ解釈に極めて重要です.
•
1Ch-1Fh (4バイト): ディスクサイズ (DWORD, ヘッダサイズ含む).
•
20h以降 (4バイト * 160または164エントリ): トラックテーブル。各トラックデータのD88ファイル内でのオフセットを示すDWORD配列.。0は未使用/未フォーマットトラック.。最初の非ゼロオフセットが実際のヘッダサイズを示唆します.。
C. トラックデータエリアとセクタ表現
トラックデータエリアは、ヘッダのトラックテーブルが指す位置にあります.。トラックデータ内にトラックヘッダはありません.。
D. D88セクタヘッダ詳細
各トラックデータ内のセクタ表現 (16バイトのセクタヘッダ + データ):
•
00h (1バイト): C (トラック番号).
•
01h (1バイト): H (ヘッド番号).
•
02h (1バイト): R (セクタ番号).
•
03h (1バイト): N (セクタサイズコード, バイト/セクタ = 128 \ll N). セクタデータサイズの決定に最も信頼できます.
•
04h-05h (2バイト): このトラック内のセクタ数 (WORD).
•
06h (1バイト): 密度フラグ (00h=MFM/倍密度, 40h=FM/単密度).
•
07h (1バイト): DDAMフラグ (00h=DAM, 10h=DDAM).
•
08h (1バイト): FDCステータスコード (00h=正常, B0h=データCRCエラー等).
•
09h-0Dh (5バイト): 予約済み.
•
0Eh-0Fh (2バイト): 実データサイズ (WORD)。信頼性が低いとされるため、Nフィールドを優先すべきです.
•
10h以降: セクタデータ (サイズはNフィールドまたは0Eh-0Fhで決定).
E. メディアフラグと密度フラグの解釈
D88ヘッダのメディアフラグ (1Bh)はディスク全体のタイプ(2D/2DD/2HD)を示し、各セクタヘッダの密度フラグ(06h)はそのセクタが元々FMかMFMかでエンコードされていたかを示します.。N88-BASIC標準ディスクでは、トラック0はFM(40h)、他はMFM(00h)であることが一般的です.。
F. トラックオフセットテーブルの重要性
トラックテーブルは、各トラックのデータ位置をファイル内で柔軟に配置することを可能にします.。オフセット0はトラックが存在しない（未フォーマット等）ことを意味します.。これにより、部分的にイメージ化されたディスクや特殊なレイアウトのディスクも表現できます.。
V. C# 実装のための考慮事項 (ファイルシステムアクセス、ファイル操作、ブートセクタ操作)
A. D88イメージファイルの解析手順
1.
D88ファイルを開き、グローバルヘッダ (バイト0から672または688バイト) を読み込む.
2.
ヘッダのバイト1Ahで書き込み禁止フラグ、バイト1Bhでメディアフラグをチェックする.
3.
バイト1Ch-1Fhでディスクサイズを取得する.
4.
バイト20h以降のトラックテーブルを読み込む.。テーブル長はヘッダサイズによって決まる.。
5.
トラックテーブルを反復処理し、非ゼロのオフセットを持つ各エントリについて：
◦
ファイル内のそのオフセット位置にシークする.
◦
次のトラックのオフセット、またはファイル終端までのバイト数を計算し、そのトラックのRAWデータを読み込む.。
◦
トラックデータ内で、16バイトごとのセクタヘッダを順次解析する.。
◦
各セクタヘッダからC, H, R, N (セクタサイズコード), 密度フラグ, FDCステータスなどを取得する.。
◦
セクタデータサイズはNフィールド (128 \ll N) から決定する.。「実データサイズ」フィールド(0Eh-0Fh)は信頼しない方が良い.。
◦
セクタヘッダの直後に続くセクタデータ（N値で決まるサイズ）を読み込む.。
B. N88-BASICファイルシステムのナビゲーションと操作
D88パーサーがセクタデータを正確に読み取れるようになったら、その上にファイルシステムロジックを構築します.。
1. システムトラックの特定
D88ヘッダのメディアフラグ(1Bh)やイメージのトラック数からディスクタイプ (2D/40トラック or 2DD/80トラック) を判断します.。
•
2D (40トラック): システムトラックはトラック18、ヘッド1.
•
2DD (80トラック): システムトラックはトラック40、ヘッド0.
DSKF(ドライブ, 5)の値もシステムトラックを示しますが、イメージ解析時点では直接利用できません。
2. ディレクトリの読み取りとエントリ解析
システムトラックのディレクトリセクタ群 (例: 2DではT18/H1/S1-12, 2DDではT40/H0/S1-12) を読み込みます.。
読み込んだディレクトリデータを16バイトずつ処理し、各ディレクトリエントリを解析します.。
•
最初のバイト (オフセット0) でエントリの状態 (FFh=未使用, 00h=削除済み) を判断する.。
•
有効なエントリの場合、ファイル名 (0-5)、拡張子 (6-8)、属性 (9)、開始クラスタ番号 (10) を抽出します.。
3. FATの読み取りとクラスタチェーン追跡
システムトラックのFATセクタ群 (例: 2DではT18/H1/S14-16, 2DDではT40/H0/S14-16) を読み込みます.。通常3つのコピーがありますが、最初のコピーで十分な場合が多いです.。
ディレクトリエントリから得られた開始クラスタ番号を起点として、FATテーブルをインデックスとして使用し、ファイルのクラスタチェーンをたどります.。FATエントリは次のクラスタ番号を格納しており、EOFマーカ (C0h+使用セクタ数) に遭遇するまでチェーンを追跡します.。
4. クラスタから物理位置へのマッピング
FATエントリはクラスタ番号を返します.。ファイルデータを読み書きするには、クラスタ番号から対応する物理トラック、ヘッド、セクタ番号を計算する必要があります.。DSKF(ドライブ, 6)が返すクラスタあたりのセクタ数 (2D=8, Others=16) と、システムトラックの位置、データ領域の開始位置（通常トラック0から始まるがシステムトラックはスキップされる可能性あり）を考慮してマッピング関数を実装します.。
例: 2Dディスク (クラスタあたり8セクタ)。 クラスタ0: T0/H0/S1-S8 クラスタ1: T0/H0/S9-S16 クラスタ2: T0/H1/S1-S8 ... (システムトラック T18/H1 をスキップして番号を振る必要があるか要確認。DSKF(ドライブ,5)がシステムトラックのクラスタ番号を返すか等).
5. ファイルデータの読み書き
ファイルのクラスタチェーンが判明したら.：
•
読み込み: チェーン内の各クラスタについて、対応する物理セクタ（クラスタ定義に基づき計算）をD88イメージから読み出し、それらを連結してファイルデータを再構築します.。
•
書き込み: 書き込むファイルサイズに応じたクラスタ数が必要になります.。ディスク上の空きクラスタ (FATエントリ=FFh) を探し、それらをファイルに割り当ててFATチェーンを構築します.。対応する物理セクタ位置を計算し、D88イメージファイル内の該当箇所にデータを書き込みます.。最終クラスタではEOFマーカ (C0h+使用セクタ数) を正しくFATに書き込む必要があります.。
6. ファイル属性の操作
ディレクトリエントリのバイト9（属性バイト）を読み書きすることでファイル属性を操作できます.。 属性バイトの詳細（ビットフィールド）：
•
バイナリ(BLOAD対象): ビット0
•
書き込み禁止: ビット4
•
編集禁止(Pオプション): ビット5
•
ASCII/トークン化: ビット7
これらのビットを操作し、変更した16バイトのディレクトリエントリ全体をD88イメージ内の対応する位置に書き戻します.。
7. ファイルの削除
ファイルを削除するには：
1.
ディレクトリエントリの最初のバイト (オフセット0) を 00h に書き換えます.。
2.
そのファイルに割り当てられていた全てのクラスタのFATエントリを (FF)FFh (空きマーカ) に書き換えます.。
これらの変更をD88イメージファイル内の対応する箇所に書き戻します。
C. ブートセクタ (IPL) へのアクセスと書き込み
プライマリブートセクタ（IPL）は、D88イメージ内でトラック0、ヘッド0、セクタ1のデータとして格納されています.。
•
このセクタをD88イメージから読み出す際は、まずトラック0のオフセットをトラックテーブルから取得し、そのトラックデータ内でセクタヘッダ(C=0, H=0, R=1)を探します.。
•
セクタヘッダのNフィールドと密度フラグ(通常N=0/128バイト, 密度40h/FM)を確認し、それに続くセクタデータを読み取ります.。
•
ブートセクタの内容を書き換える場合は、読み出したセクタデータを修正し、D88イメージ内の元の位置に書き戻します.。特にN88-BASICシステムディスクの場合、トラック0はFMエンコード（通常128バイト）であり、IPLは256バイト長である可能性が示唆されている点に注意が必要です.（論理的な読み込みサイズと物理セクタサイズの差異をどう扱うか）。
•
N88-BASICシステムディスクのIDセクタ (T18/H1/S13またはT40/H0/S13) のバイト2-255を書き換えることでも、起動時のBASICコードを変更できます.。
D. ファイルタイプの処理
ファイル属性バイト (特にビット0とビット7) を参照してファイルタイプを判断し、内容を適切に表示または処理します.。
•
ASCII (ビット7=0): テキストとして扱います.。
•
トークン化BASIC (ビット7=1): 特殊な構造を持つため、内容を表示するにはトークンを文字列に変換するロジックが必要です.。
•
バイナリ (ビット0=1): RAWバイトデータとして扱います.。
E. 非標準フォーマットへの対応と限界
多くの商用ゲームは非標準フォーマットやコピープロテクションを使用しており、N88-BASICファイルシステム規約に従いません.。D88イメージはこれらの低レベル詳細を保存しますが、標準的なN88-BASICファイルシステムリーダーはこれらのディスクを正しく解釈できません.。カスタムフォーマットへの完全な対応には、個別のディスク固有のリバースエンジニアリングが必要です.。C#プログラムはまず標準N88-BASICフォーマットの完全サポートを目指すべきです.。
F. 潜在的な参照ツール/ライブラリ
C#プログラム開発にあたり、他の言語で書かれた既存のD88ツールやエミュレータのソースコード（例: pc88-cプロジェクトのmaked88.pyやipl.z80/disk.z80, PC8801FabGL, M88, Quasi88）は、D88解析、N88-BASICファイルシステムロジック、カスタムフォーマット処理に関すsる貴重な洞察を提供できます.。
--------------------------------------------------------------------------------
これは、提供されたソースから抽出された、N88-BASICディスクイメージ操作に必要な主要な技術情報です。C#プログラムを実装する際には、これらの仕様に基づいてD88ファイルの読み書きロジック、ファイルシステム構造の解析、およびファイル操作関数を構築していくことになります。